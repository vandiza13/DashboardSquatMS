'use client';

import { useState, useEffect } from 'react';
import { FaTimes, FaCopy, FaWhatsapp } from 'react-icons/fa';

export default function ReportModal({ isOpen, onClose, categoryFilter = 'ALL' }) {
    const [reportText, setReportText] = useState('Memuat data...');
    const [loading, setLoading] = useState(false);

    // Fungsi Generate Teks (Mirip logic script.js lama)
    const generateText = (data) => {
        const { running, closed } = data;
        const total = running.length + closed.length;
        
        // Format Waktu WIB
        const now = new Date();
        const optionsDate = { timeZone: 'Asia/Jakarta', day: '2-digit', month: '2-digit', year: 'numeric' };
        const optionsTime = { timeZone: 'Asia/Jakarta', hour: '2-digit', minute: '2-digit', hour12: false };
        const tanggal = new Intl.DateTimeFormat('id-ID', optionsDate).format(now).replace(/\//g, '-');
        const jam = new Intl.DateTimeFormat('id-ID', optionsTime).format(now).replace(':', '.');

        let t = `*Monitoring Tiket ${categoryFilter === 'ALL' ? 'SEMUA KATEGORI' : categoryFilter} Area Bekasi*\n`;
        t += `*Tanggal : ${tanggal}*\n`;
        t += `*Jam : ${jam}*\n`;
        t += `================================\n`;
        
        t += `*).Jumlah Tiket Total : ${total} Tiket*\n`;
        t += `- Sisa Tiket Running : ${running.length} tiket\n`;
        t += `- Tiket Closed Hari Ini : ${closed.length} tiket\n\n`;

        // List Closed
        if (closed.length > 0) {
            t += `*)Closed : ${closed.length} tiket\n`;
            closed.forEach((tik, i) => {
                t += `${i + 1}.âœ… ${tik.id_tiket}  ${tik.deskripsi || '-'}\n`;
                t += `   RCA : ${tik.update_progres || 'Done'}\n`;
                t += `   Teknisi : ${tik.technician_names || '-'}\n\n`;
            });
        } else {
            t += `*)Closed : 0 tiket\n\n`;
        }

        // List Running
        if (running.length > 0) {
            t += `*).ON Progres : ${running.length} tiket\n`;
            running.forEach((tik, i) => {
                const icon = tik.status === 'SC' ? 'ðŸŸ¡' : 'âŒ';
                t += `${i + 1}.${icon} ${tik.id_tiket}  ${tik.deskripsi || '-'}\n`;
                t += `   Update : ${tik.update_progres || 'Belum ada update'}\n`;
                t += `   Teknisi : ${tik.technician_names || '-'}\n\n`;
            });
        } else {
            t += `*).ON Progres : 0 tiket\n`;
        }

        t += `----------------------------------------\n`;
        t += `_Generated by Dashboard System_`;
        
        return t;
    };

    useEffect(() => {
        if (isOpen) {
            setLoading(true);
            setReportText('Sedang menyusun laporan...');
            
            fetch(`/api/reports/daily?category=${categoryFilter}`)
                .then(res => res.json())
                .then(data => {
                    const text = generateText(data);
                    setReportText(text);
                })
                .catch(err => {
                    setReportText('Gagal memuat data laporan: ' + err.message);
                })
                .finally(() => setLoading(false));
        }
    }, [isOpen, categoryFilter]);

    const handleCopy = () => {
        navigator.clipboard.writeText(reportText);
        alert('Laporan berhasil disalin!');
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
            <div className="w-full max-w-2xl rounded-2xl bg-white shadow-2xl flex flex-col max-h-[90vh]">
                <div className="flex items-center justify-between bg-slate-900 px-6 py-4 text-white rounded-t-2xl">
                    <h3 className="text-lg font-bold flex items-center gap-2">
                        <FaWhatsapp className="text-green-400" /> Generator Laporan
                    </h3>
                    <button onClick={onClose} className="text-slate-400 hover:text-white">
                        <FaTimes size={20} />
                    </button>
                </div>

                <div className="p-6 flex-1 overflow-hidden flex flex-col">
                    <div className="alert alert-info text-sm mb-3">
                        Laporan ini mencakup semua tiket <strong>Running</strong> dan tiket <strong>Closed (Hari Ini)</strong>.
                    </div>
                    <textarea 
                        className="w-full flex-1 rounded-lg border border-slate-300 p-4 font-mono text-sm focus:border-blue-500 focus:outline-none bg-slate-50"
                        value={reportText}
                        readOnly
                        style={{ minHeight: '300px' }}
                    ></textarea>
                </div>

                <div className="flex justify-end gap-3 border-t bg-slate-50 px-6 py-4 rounded-b-2xl">
                    <button onClick={onClose} className="rounded-lg px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200">
                        Tutup
                    </button>
                    <button 
                        onClick={handleCopy}
                        disabled={loading}
                        className="flex items-center gap-2 rounded-lg bg-green-600 px-6 py-2 text-sm font-medium text-white hover:bg-green-700 disabled:opacity-50"
                    >
                        <FaCopy /> Salin Teks
                    </button>
                </div>
            </div>
        </div>
    );
}